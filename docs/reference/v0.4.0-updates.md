# Version 0.4.0 Updates

## Summary

Version 0.4.0 addresses reviewer feedback on the CST extraction pipeline by adding critical validation, improved documentation, and enhanced QC capabilities.

---

## New Features

### 1. Coordinate Validation System (Critical)

**Problem Addressed**: Tractogram/FA coordinate mismatches can produce anatomically plausible but incorrect results - the most serious risk in automated CST extraction.

**Implementation**:
- New module: [`coordinate_validation.py`](../../src/csttool/extract/modules/coordinate_validation.py)
- Automatic validation before extraction begins
- Three validation checks:
  1. **Bounding box check**: Verifies streamlines fall within FA volume
  2. **Unit detection**: Flags voxel-space coordinates (0-256 range)
  3. **Orientation check**: Verifies RAS coordinate consistency

**Usage**:
```bash
# Automatic validation (default behavior)
csttool extract --tractogram t.trk --fa fa.nii.gz --out results/

# Skip validation (not recommended)
csttool extract --tractogram t.trk --fa fa.nii.gz --out results/ --skip-coordinate-validation
```

**Error Example**:
```
Error: Coordinate validation failed. This can lead to incorrect results.
Errors: Coordinate space mismatch detected: values suggest voxel indices, not mm
```

### 2. Hemisphere Separation QC Visualization

**Purpose**: Verify correct hemisphere assignment and detect cross-hemisphere contamination.

**Layout**: 2 rows Ã— 3 columns
- Row 1: Coronal views (Left | Combined | Right)
- Row 2: Axial views (Left | Combined | Right)

**Features**:
- Midline reference at X=0
- Cross-hemisphere contamination metrics
- Color-coded QC status:
  - Green: Good separation (<10% contamination)
  - Red: Warning (>10% contamination)

**Output**: `{subject}_hemisphere_separation.png` in visualizations/ directory

### 3. Quiet Mode for Batch Pipelines

**Commands**: `extract`, `run`, `batch`

**Usage**:
```bash
# Suppress progress messages (errors still shown)
csttool extract --tractogram t.trk --fa fa.nii.gz --out results/ --quiet
csttool run --dwi dwi.nii.gz --out results/ --quiet
csttool batch --manifest batch.yaml --out batch_results/ --quiet
```

---

## Documentation Updates

### Enhanced Limitations Documentation
- **File**: [`docs/explanation/limitations.md`](../../docs/explanation/limitations.md)
- **Added**:
  - Coordinate validation as main technical risk
  - Registration QC limitations (no automatic acceptance criteria)
  - CST candidate bundle interpretation
  - Explicit statement: outputs are "CST candidate bundles" not definitive CST

### Coordinate Space Requirements
- **File**: [`docs/getting-started/data-requirements.md`](../../docs/getting-started/data-requirements.md)
- **Added**:
  - World coordinates (mm) requirement
  - Voxel vs world space detection
  - Code example for converting voxel to world coordinates

### Updated CLI Reference
- **File**: [`docs/reference/cli/extract.md`](../../docs/reference/cli/extract.md)
- **Added**:
  - Step 0: Coordinate Validation
  - New CLI flags documentation
  - Hemisphere separation visualization info
  - Troubleshooting section for coordinate validation errors

---

## Testing

### New Tests
- **File**: [`tests/extract/test_coordinate_validation.py`](../../tests/extract/test_coordinate_validation.py)
- 7 comprehensive tests covering:
  - Valid tractogram validation
  - Voxel-space detection
  - Out-of-bounds detection
  - Strict mode behavior
  - Metadata reporting
  - Empty tractogram handling
  - Verbose output

### Test Results
```
102 tests passed (including 7 new coordinate validation tests)
0 failures
Test execution time: ~14 seconds
```

---

## Version Information

- **Version**: 0.4.0
- **Release Date**: 2026-01-28
- **Previous Version**: 0.3.1
- **Changelog**: [`CHANGELOG.md`](../../CHANGELOG.md)

---

## Files Modified

### Core Implementation
- `src/csttool/__init__.py` - Version bump to 0.4.0
- `src/csttool/extract/modules/coordinate_validation.py` - New validation module
- `src/csttool/extract/modules/visualizations.py` - Added hemisphere separation viz
- `src/csttool/extract/modules/__init__.py` - Updated exports
- `src/csttool/cli/commands/extract.py` - Integrated validation, added --quiet
- `src/csttool/cli/commands/run.py` - Added --quiet flag
- `src/csttool/cli/commands/batch.py` - Added --quiet flag
- `src/csttool/cli/__init__.py` - Added CLI flags

### Documentation
- `docs/explanation/limitations.md` - Comprehensive limitations documentation
- `docs/getting-started/data-requirements.md` - Coordinate space requirements
- `docs/reference/cli/extract.md` - Updated with new features
- `CHANGELOG.md` - Version 0.4.0 entry

### Tests
- `tests/extract/test_coordinate_validation.py` - New test suite

---

## Migration Guide

### For Existing Users

**No breaking changes** - all existing pipelines continue to work.

**New behavior**:
- Coordinate validation now runs automatically
- May catch previously silent failures
- Use `--skip-coordinate-validation` only if absolutely necessary

**Recommended actions**:
1. Review new [limitations documentation](../../docs/explanation/limitations.md)
2. Verify tractograms are in world coordinates (mm)
3. Check new hemisphere separation visualizations for quality assessment
4. Consider using `--quiet` for batch processing

---

## Acknowledgments

These updates address feedback from thesis review emphasizing:
1. Coordinate validation as the primary technical risk
2. Registration QC transparency
3. Clear documentation of CST candidate vs definitive CST
4. User-friendly batch processing
